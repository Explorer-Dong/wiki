# 本工作流的详细中文解析见：https://wiki.dwj601.cn/develop/tools/git/github/#快速上手

name: Deploy Website to Aliyun OSS

on:
  push

jobs:
  main:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0  # fetch all commit history

    - name: Setup python
      uses: actions/setup-python@v6
      with:
        python-version: '3.14.2'
    
    - name: Setup uv
      uses: astral-sh/setup-uv@v7
      with:
        activate-environment: "true"
    
    - name: Install python dependence
      run: uv sync
    
    - name: Restore cache
      uses: actions/cache/restore@v4
      with:
        key: wiki-${{ hashfiles('.cache/**') }}
        path: ~/.cache
        restore-keys: |
          wiki-
    
    - name: Build website
      run: mkdocs build -f mkdocs.yml
      env:
        # prevent "git-committers 403 rate limit exceeded" error
        MKDOCS_GIT_COMMITTERS_APIKEY: ${{ secrets.MKDOCS_GIT_COMMITTERS_APIKEY }}
        # CI will enable some plugins that consume time-consuming builds
        CI: true
    
    - name: Save cache
      uses: actions/cache/save@v4
      with:
        key: wiki-${{ hashfiles('.cache/**') }}
        path: ~/.cache
    
    - name: Setup Aliyun CLI
      uses: aliyun/setup-aliyun-cli-action@v1
    
    - name: Config Aliyun CLI
      run: |
        aliyun configure set \
          --mode AK \
          --region ${{ vars.REGION }} \
          --access-key-id ${{ secrets.ALIYUN_ACCESS_KEY_ID  }} \
          --access-key-secret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET  }}

    - name: Deploy to Aliyun OSS
      run: |
        aliyun ossutil cp oss://public-assets-shanghai/files/BingSiteAuth.xml ${{ vars.WEB_OSS_PATH }} -f
        aliyun ossutil cp ./site/ ${{ vars.WEB_OSS_PATH }} -r -u -j 20
    
    - name: Refresh Aliyun CDN
      run: |
        aliyun cdn RefreshObjectCaches \
          --region ${{ vars.REGION }} \
          --ObjectPath ${{ vars.WEB_DIRECTORY }} \
          --ObjectType Directory \
          --Force false
